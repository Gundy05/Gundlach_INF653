<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Wishlist</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .controls { align-items:center; gap:12px; display:flex; }
    .img-toggle { display:inline-flex; align-items:center; gap:10px; padding:6px 10px; border-radius:999px; background:#8b0000; color:#fff; font-weight:700; cursor:pointer; border:0; box-shadow:0 2px 6px rgba(0,0,0,0.25); transition:background .15s ease, transform .06s ease; }
    .img-toggle.on { background:#20b038; }
    .img-toggle .dot { width:14px; height:14px; border-radius:50%; background:#fff; box-shadow:inset 0 -2px 0 rgba(0,0,0,0.15); flex:0 0 auto; }

    .search-row { width:100%; display:flex; justify-content:center; padding:12px 16px; }
    .search { width:100%; max-width:780px; display:flex; gap:8px; align-items:center; }
    .search input[type="search"]{ flex:1 1 auto; padding:10px 12px; border-radius:8px; border:0; background:rgba(255,255,255,0.04); color:#fff; font-size:1rem; outline-offset:2px; }
    .search button{ padding:10px 12px; border-radius:8px; border:0; background:var(--accent); color:#000b1a; font-weight:700; cursor:pointer; min-width:84px; }

    body.images-off .card-movie img { display:none; }
    body.images-off .card-movie { padding:14px 12px; display:flex; align-items:center; min-height:auto; }
    body.images-off .card-movie .meta { padding:0; }
    body.images-off .card-movie .meta strong{ display:block; font-size:1.05rem; color:var(--accent); }
    body.images-off .card-movie .meta .sub{ display:block; color:var(--muted); margin-top:6px; font-size:0.95rem; }

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--gap);margin-top:18px}
    .card-movie{ background:linear-gradient(180deg,rgba(0,0,0,0.45),rgba(0,0,0,0.6)); border-radius:var(--radius); overflow:hidden; display:flex; flex-direction:column; height:100%; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease; border:2px solid transparent; }
    .card-movie img{width:100%;height:auto;display:block;object-fit:cover}
    .card-movie .meta{padding:10px}
    .card-movie .meta .sub{display:block;color:var(--muted);font-size:var(--fs-sm);margin-top:6px}

    .card-movie:hover{ transform:translateY(-4px); box-shadow:0 10px 18px rgba(0,0,0,0.45); }
    .card-movie.selected{ border-color:#20b038; box-shadow:0 10px 24px rgba(32,176,56,0.12); transform:translateY(-6px) scale(1.01); }
    .card-movie.selected .meta strong{ color:#aef5b8; }

    .action-bar { position:fixed; left:0; right:0; bottom:18px; display:flex; justify-content:center; pointer-events:none; z-index:1200; }
    .action-bar .action-inner{ pointer-events:auto; background:#fff; border-radius:999px; padding:8px; box-shadow:0 8px 24px rgba(0,0,0,0.45); display:flex; gap:12px; align-items:center; }
    .collected-btn{ background:linear-gradient(180deg,#20b038,#17962d); color:#fff; border:none; padding:10px 16px; border-radius:999px; font-weight:700; cursor:pointer; }
    .wishlist-count{ padding:6px 10px; background:rgba(0,0,0,0.12); color:#fff; border-radius:999px; font-weight:700; }

    @media (max-width:1000px){ .grid{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:700px){ .grid{grid-template-columns:1fr;} .search-row { padding:8px 12px; } }
    @media (max-width:700px){ .search input[type="search"]{ padding:12px; } .img-toggle { padding:8px 12px; } .action-bar { bottom:12px; } .action-inner { padding:6px; gap:8px; } .collected-btn { padding:10px 12px; } }
  </style>
</head>
<body class="bb-bg">
  <header class="collection-header">
    <a class="back" href="home.html">←</a>
    <h3 class="title">My Wishlist</h3>

    <div class="controls">
      <button id="imgToggle" class="img-toggle on" aria-pressed="true" title="Toggle images">
        <span class="dot" aria-hidden="true"></span>
        <span class="label">Images</span>
      </button>

      <details class="control">
        <summary>Filter ▾</summary>
        <div class="control-group">
          <details class="subcontrol"><summary>Genre ▸</summary><ul class="option-list"><li>Action</li><li>Comedy</li><li>Drama</li><li>Horror</li><li>Sci‑Fi</li><li>Romance</li><li>Thriller</li><li>Animation</li><li>Documentary</li><li>Other</li></ul></details>
          <details class="subcontrol"><summary>Rating ▸</summary><ul class="option-list"><li>Any Rating</li><li>R</li><li>PG‑13</li><li>PG</li><li>G</li><li>NR</li></ul></details>
          <details class="subcontrol"><summary>Year ▸</summary><ul class="option-list"><li>2020s</li><li>2010s</li><li>2000s</li><li>1990s</li><li>1980s</li><li>1970s</li><li>1960s</li><li>1950s and earlier</li></ul></details>
        </div>
      </details>

      <details class="control">
        <summary>Sort ▾</summary>
        <ul class="option-list">
          <li>Release Date</li><li>Recently Added</li><li>A - Z</li>
        </ul>
      </details>
    </div>
  </header>

  <div class="search-row" role="search" aria-label="Search wishlist">
    <form class="search" id="collectionSearch" action="#" method="get" onsubmit="return false;">
      <input type="search" id="searchInput" name="q" placeholder="Search your wishlist (title, year, genre...)" aria-label="Search your wishlist">
      <button type="submit" id="searchBtn">Search</button>
    </form>
  </div>

  <main class="container">
    <section class="grid" id="movieGrid"></section>
  </main>

  <div class="action-bar" id="actionBar" aria-hidden="true" style="display:none;">
    <div class="action-inner" role="region" aria-label="Selected actions">
      <div class="wishlist-count" id="wishlistCount">0 selected</div>
      <button class="collected-btn" id="markCollected">Movie Collected</button>
    </div>
  </div>

  <script>
    // Image toggle
    (function () {
      const btn = document.getElementById('imgToggle');
      function setState(on) {
        btn.classList.toggle('on', on);
        btn.setAttribute('aria-pressed', String(on));
        document.body.classList.toggle('images-off', !on);
      }
      setState(true);
      btn.addEventListener('click', () => setState(!btn.classList.contains('on')));
      btn.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); } });
    })();

    // Search filter
    (function () {
      const form = document.getElementById('collectionSearch');
      const input = document.getElementById('searchInput');
      const grid = document.getElementById('movieGrid');

      function normalize(s) { return (s || '').toLowerCase(); }
      function applyFilter(q) {
        const term = normalize(q).trim();
        const cards = Array.from(grid.querySelectorAll('.card-movie'));
        if (!term) { cards.forEach(c => c.style.display = ''); return; }
        cards.forEach(card => {
          const title = normalize(card.dataset.title || card.querySelector('strong')?.textContent);
          const meta = normalize(card.dataset.meta || card.querySelector('.sub')?.textContent);
          const match = title.includes(term) || meta.includes(term);
          card.style.display = match ? '' : 'none';
        });
      }

      form.addEventListener('submit', function (e) { e.preventDefault(); applyFilter(input.value); });
      input.addEventListener('input', function () { applyFilter(this.value); });
    })();
  </script>

  <script type="module">
    import { store, notify } from './data-store.js';

    const grid = document.getElementById('movieGrid');
    const actionBar = document.getElementById('actionBar');
    const wishlistCount = document.getElementById('wishlistCount');
    const markCollectedBtn = document.getElementById('markCollected');

    function updateActionBar() {
      const selected = grid.querySelectorAll('.card-movie.selected');
      const count = selected.length;
      if (count > 0) {
        actionBar.style.display = 'flex';
        actionBar.setAttribute('aria-hidden', 'false');
        wishlistCount.textContent = `${count} selected`;
      } else {
        actionBar.style.display = 'none';
        actionBar.setAttribute('aria-hidden', 'true');
        wishlistCount.textContent = '0 selected';
      }
    }

    function attachSelectionHandlers(card) {
      card.addEventListener('click', () => {
        const isSelected = card.classList.toggle('selected');
        card.setAttribute('aria-pressed', String(isSelected));
        updateActionBar();
      });
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          const isSelected = card.classList.toggle('selected');
          card.setAttribute('aria-pressed', String(isSelected));
          updateActionBar();
        }
      });
    }

    function renderItem(item) {
      const card = document.createElement('article');
      card.className = 'card-movie';
      card.dataset.id = item.id;
      card.dataset.title = item.title;
      card.dataset.meta = item.meta;
      card.tabIndex = 0;
      card.role = 'button';
      card.setAttribute('aria-pressed', 'false');
      card.innerHTML = `
        <img src="${item.image ?? 'images/placeholder.jpg'}" alt="${item.title}">
        <div class="meta">
          <strong>${item.title}</strong>
          <span class="sub">${item.meta ?? ''}</span>
        </div>`;
      attachSelectionHandlers(card);
      return card;
    }

    window.addEventListener('load', async () => {
      notify(navigator.onLine ? "Online: using Firebase" : "Offline: using IndexedDB");
      const items = await store.readAll("wishlist");
      grid.innerHTML = '';
      items.forEach(i => grid.appendChild(renderItem(i)));
      updateActionBar();
    });

    // Move selected wishlist items into collection (and remove from wishlist)
    markCollectedBtn.addEventListener('click', async () => {
      const cards = Array.from(grid.querySelectorAll('.card-movie.selected'));
      if (cards.length === 0) return;

      for (const c of cards) {
        const item = {
          id: c.dataset.id ?? crypto.randomUUID(),
          title: c.dataset.title || c.querySelector('strong')?.textContent,
          meta: c.dataset.meta || c.querySelector('.sub')?.textContent,
          image: c.querySelector('img')?.getAttribute('src')
        };
        // Remove any existing duplicate in movies by id or title
        const movies = await store.readAll('movies');
        const dup = movies.find(x => (x.id && x.id === item.id) || (x.title && x.title === item.title));
        if (dup) await store.deleteById('movies', dup.id);
        // Create in movies, then remove from wishlist
        await store.create('movies', item);
        const wishId = c.dataset.id;
        if (wishId) await store.deleteById('wishlist', wishId);
        c.remove();
      }
      updateActionBar();
      notify(navigator.onLine ? 'Moved to Collection' : 'Moved offline; will sync');
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('Service Worker registered:', reg))
        .catch(err => console.error('Service Worker registration failed:', err));
    }
  </script>
</body>
</html>
