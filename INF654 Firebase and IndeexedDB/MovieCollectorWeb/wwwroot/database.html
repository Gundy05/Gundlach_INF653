<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Movie Database</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="manifest" href="manifest.json">
  <style>
    .controls { align-items: center; gap: 12px; display: flex; }
    .img-toggle { display:inline-flex; align-items:center; gap:10px; padding:6px 10px; border-radius:999px; background:#8b0000; color:#fff; font-weight:700; cursor:pointer; border:0; }
    .img-toggle.on { background:#20b038; }
    .img-toggle .dot { width:14px; height:14px; border-radius:50%; background:#fff; }

    .search-row { width:100%; display:flex; justify-content:center; padding:12px 16px; }
    .search { width:100%; max-width:780px; display:flex; gap:8px; align-items:center; }
    .search input[type="search"] { flex:1; padding:10px 12px; border-radius:8px; border:0; background:rgba(255,255,255,0.04); color:#fff; }
    .search button { padding:10px 12px; border-radius:8px; border:0; background:var(--accent); color:#000b1a; font-weight:700; cursor:pointer; }

    .grid { display:grid; grid-template-columns:repeat(3,1fr); gap:var(--gap); margin-top:18px; }
    .card-movie { position:relative; background:linear-gradient(180deg,rgba(0,0,0,0.45),rgba(0,0,0,0.6)); border-radius:var(--radius); overflow:hidden; display:flex; flex-direction:column; border:2px solid transparent; cursor:pointer; }
    .card-movie img { width:100%; height:auto; object-fit:cover; }
    .card-movie .meta { padding:10px; }
    .card-movie.selected { border-color:#20b038; }

    .badge { position:absolute; top:8px; right:8px; padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:700; color:#fff; }
    .badge.wishlist { background:#ffd400; color:#000; }
    .badge.collection { background:#20b038; }

    .action-bar { position:fixed; left:0; right:0; bottom:18px; display:flex; justify-content:center; pointer-events:none; }
    .action-bar .action-inner { pointer-events:auto; background:#fff; border-radius:999px; padding:8px; box-shadow:0 8px 24px rgba(0,0,0,0.45); display:flex; gap:10px; align-items:center; }
    .action-btn { background:linear-gradient(180deg,#20b038,#17962d); color:#fff; border:none; padding:10px 14px; border-radius:999px; font-weight:700; cursor:pointer; }
    .wishlist-count { padding:6px 10px; background:rgba(0,0,0,0.12); color:#000; border-radius:999px; font-weight:700; }
  </style>
</head>
<body class="bb-bg">
  <header class="collection-header">
    <a class="back" href="home.html">â†</a>
    <h3 class="title">Movie Database</h3>
    <div class="controls">
      <button id="imgToggle" class="img-toggle on" aria-pressed="true">
        <span class="dot"></span><span class="label">Images</span>
      </button>
    </div>
  </header>

  <div class="search-row">
    <form class="search" id="collectionSearch" onsubmit="return false;">
      <input type="search" id="searchInput" placeholder="Search movies (title, year, genre...)">
      <button type="submit">Search</button>
    </form>
  </div>

  <main class="container">
    <section class="grid" id="movieGrid"></section>
  </main>

  <div class="action-bar" id="actionBar" style="display:none;">
    <div class="action-inner">
      <div class="wishlist-count" id="wishlistCount">0 selected</div>
      <button class="action-btn" id="addToWishlist">Add to Wishlist</button>
      <button class="action-btn" id="addToCollection">Add to Collection</button>
    </div>
  </div>

  <script>
    // Image toggle
    (function () {
      const btn=document.getElementById('imgToggle');
      function setState(on){btn.classList.toggle('on',on);btn.setAttribute('aria-pressed',String(on));document.body.classList.toggle('images-off',!on);}
      setState(true);
      btn.addEventListener('click',()=>setState(!btn.classList.contains('on')));
    })();

    // Search filter
    (function () {
      const form=document.getElementById('collectionSearch');
      const input=document.getElementById('searchInput');
      const grid=document.getElementById('movieGrid');
      function norm(s){return (s||'').toLowerCase();}
      function applyFilter(q){
        const term=norm(q).trim();
        const cards=Array.from(grid.querySelectorAll('.card-movie'));
        if(!term){cards.forEach(c=>c.style.display='');return;}
        cards.forEach(card=>{
          const title=norm(card.dataset.title);
          const meta=norm(card.dataset.meta);
          card.style.display=(title.includes(term)||meta.includes(term))?'':'none';
        });
      }
      form.addEventListener('submit',e=>{e.preventDefault();applyFilter(input.value);});
      input.addEventListener('input',()=>applyFilter(input.value));
    })();

    // Selection logic
    (function () {
      const grid=document.getElementById('movieGrid');
      const actionBar=document.getElementById('actionBar');
      const wishlistCount=document.getElementById('wishlistCount');
      function updateActionBar(){
        const selected=grid.querySelectorAll('.card-movie.selected');
        const count=selected.length;
        if(count>0){actionBar.style.display='flex';wishlistCount.textContent=`${count} selected`;}
        else{actionBar.style.display='none';wishlistCount.textContent='0 selected';}
      }
      grid.addEventListener('click',e=>{
        const card=e.target.closest('.card-movie');
        if(!card)return;
        const isSelected=card.classList.toggle('selected');
        card.setAttribute('aria-pressed',String(isSelected));
        updateActionBar();
      });
    })();
  </script>

  <script type="module">
    import { store, notify } from './data-store.js';
    const addToWishlistBtn=document.getElementById('addToWishlist');
    const addToCollectionBtn=document.getElementById('addToCollection');

    async function ensureExclusiveAdd(target,item){
      const other=target==='wishlist'?'movies':'wishlist';
      const otherItems=await store.readAll(other);
      const dup=otherItems.find(x=>x.id===item.id||x.title===item.title);
      if(dup) await store.deleteById(other,dup.id);
      await store.create(target,item);
    }

    function selectedCards(){return Array.from(document.querySelectorAll('.card-movie.selected'));}

    addToWishlistBtn.addEventListener('click',async()=>{
      const cards=selectedCards(); if(cards.length===0) return;
      for(const c of cards){
        const item={id:c.dataset.id,title:c.dataset.title,meta:c.dataset.meta,image:c.querySelector('img')?.src};
        await ensureExclusiveAdd('wishlist',item);
        c.classList.remove('selected'); c.setAttribute('aria-pressed','false');
      }
      notify('Added to Wishlist');
    });

    addToCollectionBtn.addEventListener('click',async()=>{
      const cards=selectedCards(); if(cards.length===0) return;
      for(const c of cards){
        const item={id:c.dataset.id,title:c.dataset.title,meta:c.dataset.meta,image:c.querySelector('img')?.src};
        await ensureExclusiveAdd('movies',item);
        c.classList.remove('selected'); c.setAttribute('aria-pressed','false');
      }
      notify('Added to Collection');
    });
  </script>

  <!-- Seeding + Rendering with badges -->
  <script type="module">
    import { store } from './data-store.js';
    const grid=document.getElementById('movieGrid');

    const sampleMovies=[
      { title:"The Dark Knight", meta:"Action Â· PGâ€‘13 Â· 2000s", image:"images/dark-knight.jpg" },
      { title:"Inception", meta:"Sciâ€‘Fi Â· PGâ€‘13 Â· 2010s", image:"images/inception.jpg" },
      { title:"Titanic", meta:"Romance Â· PGâ€‘13 Â· 1990s", image:"images/titanic.jpg" },
      { title:"Toy Story", meta:"Animation Â· G Â· 1990s", image:"images/toy-story.jpg" },
      { title:"The Godfather", meta:"Drama Â· R Â· 1970s", image:"images/godfather.jpg" },
      { title:"Black Panther", meta:"Action Â· PGâ€‘13 Â· 2010s", image:"images/black-panther.jpg" },
      { title:"Parasite", meta:"Thriller Â· R Â· 2010s", image:"images/parasite.jpg" },
      { title:"Casablanca", meta:"Romance Â· NR Â· 1940s", image:"images/casablanca.jpg" },
      { title:"Star Wars: A New Hope", meta:"Sciâ€‘Fi Â· PG Â· 1970s", image:"images/star-wars.jpg" },
      { title:"The Lion King", meta:"Animation Â· G Â· 1990s", image:"images/lion-king.jpg" }
    ];

    function renderMovie(m,status){
      const card=document.createElement('article');
      card.className='card-movie';
      card.dataset.id=m.id ?? crypto.randomUUID();
      card.dataset.title=m.title;
      card.dataset.meta=m.meta;
      card.tabIndex=0;
      card.role='button';
      card.setAttribute('aria-pressed','false');
      card.innerHTML=`
        <img src="${m.image ?? 'images/placeholder.jpg'}" alt="${m.title}">
        <div class="meta">
          <strong>${m.title}</strong>
          <span class="sub">${m.meta}</span>
        </div>
        ${status ? `<span class="badge ${status}">${status==='wishlist'?'â­ Wishlist':'ğŸï¸ Collection'}</span>`:''}
      `;
      return card;
    }

    window.addEventListener('load',async()=>{
      // Seed collection if empty
      const existing=await store.readAll('movies');
      if(existing.length===0){
        for(const m of sampleMovies){
          await store.create('movies',{id:crypto.randomUUID(),...m});
        }
        console.log("Sample movies seeded!");
      }

      const movies=await store.readAll('movies');
      const wishlist=await store.readAll('wishlist');

      grid.innerHTML='';
      // Render every catalog title
      sampleMovies.forEach(m=>{
        let status=null;
        if(wishlist.find(w=>w.title===m.title)) {
          status='wishlist';
        } else if(movies.find(c=>c.title===m.title)) {
          status='collection';
        }
        grid.appendChild(renderMovie(m,status));
      });
    });
  </script>

  <script>
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js')
        .then(reg=>console.log('Service Worker registered:',reg))
        .catch(err=>console.error('Service Worker registration failed:',err));
    }
  </script>
</body>
</html>
